---
title: "Instacart Modeling"
author: "James Kim"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup}
devtools::load_all('.')
library(data.table)
library(dplyr)
library(magrittr)
library(MASS)
library(scales)
library(ggplot2)
```

```{r data}
data(aisles)
data(departments)
data(order_products_prior)
data(order_products_train)
data(orders)
data(products)
data(sample_submission)

setkey(orders, order_id)
setkey(order_products_prior, order_id)
prior_orders <- orders[eval_set == 'prior'][order_products_prior]

setkey(products, product_id)
setkey(prior_orders, product_id)
prior_orders <- products[prior_orders]

dataset <- order_products_train %>% 
  dplyr::left_join(y = orders %>% 
                     dplyr::select(order_id, user_id) %>% 
                     unique(), 
                   by = 'order_id') %>% 
  dplyr::group_by(user_id, order_id) %>%
  tidyr::nest() %>%
  dplyr::mutate(
    actual_products = purrr::map_chr(
      data, 
      ~paste(.x$product_id[.x$reordered == 1], collapse = ' ')
    ),
    product_ids = purrr::map2(
      user_id,
      data,
      ~prior_orders[user_id == .x, 'product_id'] %>% 
        unique() %>%
        dplyr::left_join(y = .y %>% 
                           dplyr::select(-add_to_cart_order), 
                         by = 'product_id') %>%
        dplyr::mutate(reordered = replace(reordered, is.na(reordered), 0))
    ),
    set = 'train'
  ) %>%
  rbind(
    sample_submission %>%
      dplyr::select(order_id) %>%
      dplyr::left_join(y = orders %>%
                         dplyr::select(order_id, user_id) %>%
                         unique(),
                       by = 'order_id') %>%
      dplyr::mutate(
        data = purrr::map(user_id, ~NULL),
        actual_products = purrr::map_chr(user_id, ~NA),
        product_ids = purrr::map(
          user_id,
          ~prior_orders[user_id == .x, 'product_id'] %>% unique()
        ),
        set = 'test'
      )
  )
```

```{r baseline}
# for each user in test set, choose products that have been reordered over 50% of the time
baseline <- cust_df %>%
  dplyr::select(user_id, data) %>%
  tidyr::unnest() %>%
  dplyr::filter(!is.na(reordered)) %>%
  dplyr::group_by(user_id, product_id) %>%
  dplyr::summarise(perc_reordered = sum(reordered) / n()) %>%
  dplyr::group_by(user_id) %>%
  dplyr::summarise(products = paste(product_id[perc_reordered > .5], 
                                    collapse = ' ')) %>%
  dplyr::right_join(y = dataset %>%
                      dplyr::filter(set == 'test') %>%
                      dplyr::select(user_id, order_id),
                    by = 'user_id') %>%
  dplyr::select(order_id, products) %>%
  dplyr::arrange(order_id)

# f score of .3110698
```

```{r customer-info}
cust_df <- prior_orders %>% 
  dplyr::group_by(user_id) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    days = purrr::map_dbl(data, 
                          ~mean(.x$days_since_prior_order, na.rm = TRUE)), 
    cart_size = purrr::map_dbl(data, 
                               ~.x %>% dplyr::count(order_id) %>% .$n %>% mean()), 
    perc_reorder = purrr::map_dbl(data, 
                                  ~sum(.x$reordered) / nrow(.x)),
    perc_department = purrr::map(data,
                                 ~.x %>% 
                                   dplyr::count(department_id) %>% 
                                   dplyr::mutate(perc_order = n / sum(n)) %>% 
                                   dplyr::left_join(y = departments, 
                                                    by = 'department_id'))
  )

cust_profile <- cust_df %>% 
  dplyr::select(user_id, days, cart_size, perc_department) %>% 
  tidyr::unnest(perc_department) %>%
  dplyr::select(-department_id, -n) %>% 
  tidyr::spread(department, perc_order, fill = 0)

cluster <- kmeans(cust_profile[-1], 5)

cust_profile$customer_group = as.factor(cluster$cluster)

lda <- MASS::lda(customer_group ~ ., data = cust_profile[-1])
plda <- predict(lda, newdata = cust_profile[-1])
prop.lda <- lda$svd^2 / sum(lda$svd^2)

ggplot(data.frame(customer_group = cust_profile$customer_group,
                  lda = plda$x)) +
  geom_point(aes(x = lda.LD1, y = lda.LD2,
                 color = customer_group), alpha = .5) +
  labs(x = paste0('LD1 (', scales::percent(prop.lda[1]), ')'),
       y = paste0('LD2 (', scales::percent(prop.lda[2]), ')'))
```
  

